{"remainingRequest":"/Users/apple/WebstormProjects/vue-demo/erp-web/erp-web/node_modules/babel-loader/lib/index.js!/Users/apple/WebstormProjects/vue-demo/erp-web/erp-web/node_modules/eslint-loader/index.js??ref--13-0!/Users/apple/WebstormProjects/vue-demo/erp-web/erp-web/src/permission.js","dependencies":[{"path":"/Users/apple/WebstormProjects/vue-demo/erp-web/erp-web/src/permission.js","mtime":1569293701158},{"path":"/Users/apple/WebstormProjects/vue-demo/erp-web/erp-web/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/apple/WebstormProjects/vue-demo/erp-web/erp-web/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/Users/apple/WebstormProjects/vue-demo/erp-web/erp-web/node_modules/eslint-loader/index.js","mtime":499162500000}],"contextDependencies":[],"result":["\"use strict\";\n\nvar _interopRequireDefault = require(\"/Users/apple/WebstormProjects/vue-demo/erp-web/erp-web/node_modules/@babel/runtime/helpers/interopRequireDefault\");\n\nrequire(\"core-js/modules/es7.object.get-own-property-descriptors\");\n\nrequire(\"core-js/modules/web.dom.iterable\");\n\nrequire(\"core-js/modules/es6.object.keys\");\n\nvar _defineProperty2 = _interopRequireDefault(require(\"/Users/apple/WebstormProjects/vue-demo/erp-web/erp-web/node_modules/@babel/runtime-corejs2/helpers/defineProperty\"));\n\nrequire(\"regenerator-runtime/runtime\");\n\nvar _asyncToGenerator2 = _interopRequireDefault(require(\"/Users/apple/WebstormProjects/vue-demo/erp-web/erp-web/node_modules/@babel/runtime-corejs2/helpers/asyncToGenerator\"));\n\nvar _router = _interopRequireDefault(require(\"@/router\"));\n\nvar _store = _interopRequireDefault(require(\"@/store\"));\n\nvar _elementUi = require(\"element-ui\");\n\nvar _nprogress = _interopRequireDefault(require(\"nprogress\"));\n\nrequire(\"nprogress/nprogress.css\");\n\nvar _auth = require(\"@/utils/auth\");\n\nvar _getPageTitle = _interopRequireDefault(require(\"@/utils/get-page-title\"));\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(source, true).forEach(function (key) { (0, _defineProperty2.default)(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(source).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\n_nprogress.default.configure({\n  showSpinner: false\n});\n\nvar whiteList = ['/login', '/auth-redirect'];\n\n_router.default.beforeEach(\n/*#__PURE__*/\nfunction () {\n  var _ref = (0, _asyncToGenerator2.default)(\n  /*#__PURE__*/\n  regeneratorRuntime.mark(function _callee(to, from, next) {\n    var hasToken, hasRoles, _ref2, roles, accessRoutes;\n\n    return regeneratorRuntime.wrap(function _callee$(_context) {\n      while (1) {\n        switch (_context.prev = _context.next) {\n          case 0:\n            _nprogress.default.start();\n\n            document.title = (0, _getPageTitle.default)(to.meta.title);\n            hasToken = (0, _auth.getToken)();\n\n            if (!hasToken) {\n              _context.next = 34;\n              break;\n            }\n\n            if (!(to.path == \"/login\")) {\n              _context.next = 9;\n              break;\n            }\n\n            next({\n              path: '/'\n            });\n\n            _nprogress.default.done();\n\n            _context.next = 32;\n            break;\n\n          case 9:\n            _context.prev = 9;\n            hasRoles = _store.default.getters.roles && _store.default.getters.roles.length > 0;\n\n            if (!hasRoles) {\n              _context.next = 15;\n              break;\n            }\n\n            next();\n            _context.next = 24;\n            break;\n\n          case 15:\n            _context.next = 17;\n            return _store.default.dispatch(\"user/getUserInfo\");\n\n          case 17:\n            _ref2 = _context.sent;\n            roles = _ref2.roles;\n            _context.next = 21;\n            return _store.default.dispatch(\"permission/generateRoutes\", roles);\n\n          case 21:\n            accessRoutes = _context.sent;\n\n            _router.default.addRoutes(accessRoutes);\n\n            next(_objectSpread({}, to, {\n              replace: true\n            }));\n\n          case 24:\n            _context.next = 32;\n            break;\n\n          case 26:\n            _context.prev = 26;\n            _context.t0 = _context[\"catch\"](9);\n            _context.next = 30;\n            return _store.default.dispatch('user/resetToken');\n\n          case 30:\n            _elementUi.Message.error(_context.t0 || 'Has Error');\n\n            next(\"/login?redirect=\".concat(to.path));\n\n          case 32:\n            _context.next = 35;\n            break;\n\n          case 34:\n            if (whiteList.indexOf(to.path) !== -1) {\n              next();\n            } else {\n              next(\"/login?redirect=\".concat(to.path));\n\n              _nprogress.default.done();\n            }\n\n          case 35:\n          case \"end\":\n            return _context.stop();\n        }\n      }\n    }, _callee, null, [[9, 26]]);\n  }));\n\n  return function (_x, _x2, _x3) {\n    return _ref.apply(this, arguments);\n  };\n}());\n\n_router.default.afterEach(function (to, from, next) {\n  _nprogress.default.done();\n});",{"version":3,"sources":["/Users/apple/WebstormProjects/vue-demo/erp-web/erp-web/src/permission.js"],"names":["NProgress","configure","showSpinner","whiteList","router","beforeEach","to","from","next","start","document","title","meta","hasToken","path","done","hasRoles","store","getters","roles","length","dispatch","accessRoutes","addRoutes","replace","Message","error","indexOf","afterEach"],"mappings":";;;;;;;;;;;;;;;;AAEA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;;;;;AAEAA,mBAAUC,SAAV,CAAoB;AAACC,EAAAA,WAAW,EAAE;AAAd,CAApB;;AAEA,IAAMC,SAAS,GAAG,CAAC,QAAD,EAAW,gBAAX,CAAlB;;AAEAC,gBAAOC,UAAP;AAAA;AAAA;AAAA;AAAA;AAAA,0BAAkB,iBAAMC,EAAN,EAAUC,IAAV,EAAgBC,IAAhB;AAAA;;AAAA;AAAA;AAAA;AAAA;AACdR,+BAAUS,KAAV;;AACAC,YAAAA,QAAQ,CAACC,KAAT,GAAiB,2BAAaL,EAAE,CAACM,IAAH,CAAQD,KAArB,CAAjB;AAEME,YAAAA,QAJQ,GAIG,qBAJH;;AAAA,iBAKXA,QALW;AAAA;AAAA;AAAA;;AAAA,kBAMPP,EAAE,CAACQ,IAAH,IAAW,QANJ;AAAA;AAAA;AAAA;;AAONN,YAAAA,IAAI,CAAC;AAACM,cAAAA,IAAI,EAAE;AAAP,aAAD,CAAJ;;AACAd,+BAAUe,IAAV;;AARM;AAAA;;AAAA;AAAA;AAWIC,YAAAA,QAXJ,GAWeC,eAAMC,OAAN,CAAcC,KAAd,IAAuBF,eAAMC,OAAN,CAAcC,KAAd,CAAoBC,MAApB,GAA6B,CAXnE;;AAAA,iBAYCJ,QAZD;AAAA;AAAA;AAAA;;AAaER,YAAAA,IAAI;AAbN;AAAA;;AAAA;AAAA;AAAA,mBAewBS,eAAMI,QAAN,CAAe,kBAAf,CAfxB;;AAAA;AAAA;AAeSF,YAAAA,KAfT,SAeSA,KAfT;AAAA;AAAA,mBAgB6BF,eAAMI,QAAN,CAAe,2BAAf,EAA4CF,KAA5C,CAhB7B;;AAAA;AAgBQG,YAAAA,YAhBR;;AAiBElB,4BAAOmB,SAAP,CAAiBD,YAAjB;;AACAd,YAAAA,IAAI,mBAAKF,EAAL;AAASkB,cAAAA,OAAO,EAAE;AAAlB,eAAJ;;AAlBF;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA,mBAqBIP,eAAMI,QAAN,CAAe,iBAAf,CArBJ;;AAAA;AAsBFI,+BAAQC,KAAR,CAAc,eAAS,WAAvB;;AACAlB,YAAAA,IAAI,2BAAoBF,EAAE,CAACQ,IAAvB,EAAJ;;AAvBE;AAAA;AAAA;;AAAA;AA2BV,gBAAGX,SAAS,CAACwB,OAAV,CAAkBrB,EAAE,CAACQ,IAArB,MAA+B,CAAC,CAAnC,EAAqC;AACjCN,cAAAA,IAAI;AACP,aAFD,MAEO;AACHA,cAAAA,IAAI,2BAAoBF,EAAE,CAACQ,IAAvB,EAAJ;;AACAd,iCAAUe,IAAV;AACH;;AAhCS;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAlB;;AAAA;AAAA;AAAA;AAAA;;AAoCAX,gBAAOwB,SAAP,CAAiB,UAACtB,EAAD,EAAKC,IAAL,EAAWC,IAAX,EAAoB;AACjCR,qBAAUe,IAAV;AACH,CAFD","sourcesContent":["// 权限拦截\n\nimport router from '@/router'\nimport store from '@/store'\nimport {Message} from 'element-ui'\nimport NProgress from 'nprogress'\nimport 'nprogress/nprogress.css'\nimport {getToken} from '@/utils/auth'\nimport getPageTitle from '@/utils/get-page-title'\n\nNProgress.configure({showSpinner: false})\n\nconst whiteList = ['/login', '/auth-redirect']\n\nrouter.beforeEach(async(to, from, next) => {\n    NProgress.start();\n    document.title = getPageTitle(to.meta.title);\n\n    const hasToken = getToken();\n    if(hasToken){\n        if(to.path == \"/login\"){\n            next({path: '/'})\n            NProgress.done();\n        } else {\n            try{\n                const hasRoles = store.getters.roles && store.getters.roles.length > 0\n                if(hasRoles){\n                    next();\n                } else {\n                    const {roles} = await store.dispatch(\"user/getUserInfo\")\n                    const accessRoutes = await store.dispatch(\"permission/generateRoutes\", roles);\n                    router.addRoutes(accessRoutes);\n                    next({...to, replace: true})\n                }\n            } catch (error) {\n                await store.dispatch('user/resetToken')\n                Message.error(error || 'Has Error')\n                next(`/login?redirect=${to.path}`)\n            }\n        }\n    } else {\n        if(whiteList.indexOf(to.path) !== -1){\n            next()\n        } else {\n            next(`/login?redirect=${to.path}`)\n            NProgress.done();\n        }\n    }\n})\n\nrouter.afterEach((to, from, next) => {\n    NProgress.done();\n})"]}]}